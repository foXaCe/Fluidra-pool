name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate release notes from commits
        id: notes
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            # First release - get all commits
            COMMITS=$(git log --pretty=format:"- %s" --no-merges)
          else
            # Get commits since previous tag
            COMMITS=$(git log --pretty=format:"- %s" --no-merges ${PREV_TAG}..HEAD)
          fi

          # Categorize commits
          FEATURES=$(echo "$COMMITS" | grep -E "^- feat(\([^)]+\))?:" || true)
          FIXES=$(echo "$COMMITS" | grep -E "^- fix(\([^)]+\))?:" || true)
          DOCS=$(echo "$COMMITS" | grep -E "^- docs(\([^)]+\))?:" || true)
          REFACTOR=$(echo "$COMMITS" | grep -E "^- refactor(\([^)]+\))?:" || true)
          PERF=$(echo "$COMMITS" | grep -E "^- perf(\([^)]+\))?:" || true)
          BUILD=$(echo "$COMMITS" | grep -E "^- (build|ci)(\([^)]+\))?:" || true)
          CHORE=$(echo "$COMMITS" | grep -E "^- chore(\([^)]+\))?:" || true)
          OTHER=$(echo "$COMMITS" | grep -v -E "^- (feat|fix|docs|refactor|perf|build|ci|chore)(\([^)]+\))?:" || true)

          # Build release notes
          NOTES=""

          if [ -n "$FEATURES" ]; then
            NOTES="${NOTES}## üöÄ New Features\n\n${FEATURES}\n\n"
          fi

          if [ -n "$FIXES" ]; then
            NOTES="${NOTES}## üêõ Bug Fixes\n\n${FIXES}\n\n"
          fi

          if [ -n "$PERF" ]; then
            NOTES="${NOTES}## ‚ö° Performance\n\n${PERF}\n\n"
          fi

          if [ -n "$REFACTOR" ]; then
            NOTES="${NOTES}## üîß Refactoring\n\n${REFACTOR}\n\n"
          fi

          if [ -n "$DOCS" ]; then
            NOTES="${NOTES}## üìö Documentation\n\n${DOCS}\n\n"
          fi

          if [ -n "$BUILD" ]; then
            NOTES="${NOTES}## üèóÔ∏è Build & CI\n\n${BUILD}\n\n"
          fi

          if [ -n "$CHORE" ]; then
            NOTES="${NOTES}## üßπ Chores\n\n${CHORE}\n\n"
          fi

          if [ -n "$OTHER" ]; then
            NOTES="${NOTES}## üìù Other\n\n${OTHER}\n\n"
          fi

          # Output
          {
            echo "notes<<EOF"
            echo -e "$NOTES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ steps.version.outputs.version }}
          body: |
            ${{ steps.notes.outputs.notes }}

            ## Installation

            ### HACS (Recommended)
            1. Open HACS
            2. Add custom repository: `https://github.com/${{ github.repository }}`
            3. Search for "Fluidra Pool"
            4. Install and restart Home Assistant

            ### Manual
            1. Download the `fluidra_pool` folder from this release
            2. Copy to `custom_components/`
            3. Restart Home Assistant
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}

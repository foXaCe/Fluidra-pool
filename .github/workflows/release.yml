name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Extract changelog for this version
        id: notes
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"

          # Extract the section for this version from CHANGELOG.md
          # Matches from "## [X.Y.Z]" until the next "## [" or end of file
          NOTES=$(awk "/^## \[${VERSION}\]/{found=1; next} /^## \[/{if(found) exit} found{print}" CHANGELOG.md)

          if [ -z "$NOTES" ]; then
            # Fallback: generate from commits if CHANGELOG entry not found
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

            if [ -z "$PREV_TAG" ]; then
              COMMITS=$(git log --pretty=format:"- %s" --no-merges)
            else
              COMMITS=$(git log --pretty=format:"- %s" --no-merges ${PREV_TAG}..HEAD)
            fi

            # Filter out release/chore commits
            COMMITS=$(echo "$COMMITS" | grep -v -E "^- (release|chore: bump version)" || true)

            FEATURES=$(echo "$COMMITS" | grep -E "^- feat(\([^)]+\))?:" || true)
            FIXES=$(echo "$COMMITS" | grep -E "^- fix(\([^)]+\))?:" || true)
            REFACTOR=$(echo "$COMMITS" | grep -E "^- refactor(\([^)]+\))?:" || true)
            PERF=$(echo "$COMMITS" | grep -E "^- perf(\([^)]+\))?:" || true)
            BUILD=$(echo "$COMMITS" | grep -E "^- (build|ci)(\([^)]+\))?:" || true)
            OTHER=$(echo "$COMMITS" | grep -v -E "^- (feat|fix|docs|refactor|perf|build|ci|chore)(\([^)]+\))?:" || true)

            NOTES=""
            [ -n "$FEATURES" ] && NOTES="${NOTES}### Added\n\n${FEATURES}\n\n"
            [ -n "$FIXES" ] && NOTES="${NOTES}### Fixed\n\n${FIXES}\n\n"
            [ -n "$REFACTOR" ] && NOTES="${NOTES}### Changed\n\n${REFACTOR}\n\n"
            [ -n "$PERF" ] && NOTES="${NOTES}### Performance\n\n${PERF}\n\n"
            [ -n "$BUILD" ] && NOTES="${NOTES}### Build\n\n${BUILD}\n\n"
            [ -n "$OTHER" ] && NOTES="${NOTES}### Other\n\n${OTHER}\n\n"
          fi

          # Output
          {
            echo "notes<<EOF"
            echo -e "$NOTES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ steps.version.outputs.version }}
          body: ${{ steps.notes.outputs.notes }}
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
